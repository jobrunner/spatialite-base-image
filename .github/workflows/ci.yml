name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # =============================================================================
  # VALIDATION STAGE - Runs always first
  # =============================================================================
  validate:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      major: ${{ steps.version.outputs.major }}
      minor: ${{ steps.version.outputs.minor }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate VERSION format (SemVer)
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Check SemVer format (X.Y.Z)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::VERSION '$VERSION' is not valid SemVer format (expected X.Y.Z)"
            exit 1
          fi

          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

          echo "✓ VERSION $VERSION is valid SemVer"

      - name: Validate VERSION does not exist as tag
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')
          TAG="v${VERSION}"

          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "::error::Tag $TAG already exists. Please increment VERSION."
            exit 1
          fi

          echo "✓ Tag $TAG does not exist yet"

      - name: Validate CHANGELOG has entry for VERSION
        run: |
          VERSION=$(cat VERSION | tr -d '[:space:]')

          if ! grep -q "^## \[${VERSION}\]" CHANGELOG.md; then
            echo "::error::CHANGELOG.md has no entry for version $VERSION"
            echo "Expected a line like: ## [$VERSION] - YYYY-MM-DD"
            exit 1
          fi

          echo "✓ CHANGELOG.md has entry for version $VERSION"

  # =============================================================================
  # PR: BUILD AND TEST (no push, local images only)
  # =============================================================================
  pr-build-and-test:
    needs: validate
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - dockerfile: Dockerfile.alpine
            image_name: alpine
            dev: false
          - dockerfile: Dockerfile.alpine-dev
            image_name: alpine-dev
            dev: true
          - dockerfile: Dockerfile.ubuntu
            image_name: ubuntu
            dev: false
          - dockerfile: Dockerfile.ubuntu-dev
            image_name: ubuntu-dev
            dev: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64
          push: false
          load: true
          tags: spatialite:${{ matrix.image_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Test runtime image
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests:/tests \
            spatialite:${{ matrix.image_name }} \
            /tests/test-image.sh

      - name: Test dev image
        if: matrix.dev
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests:/tests \
            spatialite:${{ matrix.image_name }} \
            /tests/test-dev-image.sh

  # =============================================================================
  # MERGE: BUILD AND PUSH (multi-arch with SemVer tags)
  # =============================================================================
  build:
    needs: validate
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - dockerfile: Dockerfile.ubuntu
            tag_prefix: ubuntu
            is_default: false
            is_default_dev: false
          - dockerfile: Dockerfile.ubuntu-dev
            tag_prefix: ubuntu-dev
            is_default: false
            is_default_dev: false
          - dockerfile: Dockerfile.alpine
            tag_prefix: alpine
            is_default: true
            is_default_dev: false
          - dockerfile: Dockerfile.alpine-dev
            tag_prefix: alpine-dev
            is_default: false
            is_default_dev: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (standard tags)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.tag_prefix }}-${{ needs.validate.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.tag_prefix }}-${{ needs.validate.outputs.major }}.${{ needs.validate.outputs.minor }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.tag_prefix }}-${{ needs.validate.outputs.major }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.tag_prefix }}-latest
          labels: |
            org.opencontainers.image.title=spatialite-base-image
            org.opencontainers.image.description=Multi-arch Docker image with GDAL, SQLite, SpatiaLite, GEOS, librttopo
            org.opencontainers.image.version=${{ needs.validate.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.licenses=GPL-2.0-or-later
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: Build and push (default Alpine tags)
        if: matrix.is_default == true
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.major }}.${{ needs.validate.outputs.minor }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.validate.outputs.major }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.title=spatialite-base-image
            org.opencontainers.image.description=Multi-arch Docker image with GDAL, SQLite, SpatiaLite, GEOS, librttopo
            org.opencontainers.image.version=${{ needs.validate.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.licenses=GPL-2.0-or-later
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          provenance: false

      - name: Build and push (default dev tags)
        if: matrix.is_default_dev == true
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ needs.validate.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ needs.validate.outputs.major }}.${{ needs.validate.outputs.minor }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev-${{ needs.validate.outputs.major }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
          labels: |
            org.opencontainers.image.title=spatialite-base-image
            org.opencontainers.image.description=Multi-arch Docker image with GDAL, SQLite, SpatiaLite, GEOS, librttopo (dev)
            org.opencontainers.image.version=${{ needs.validate.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.licenses=GPL-2.0-or-later
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          provenance: false

  # =============================================================================
  # MERGE: TEST (on pushed images)
  # =============================================================================
  test:
    needs: [validate, build]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - image_suffix: ubuntu
            dev: false
          - image_suffix: ubuntu-dev
            dev: true
          - image_suffix: alpine
            dev: false
          - image_suffix: alpine-dev
            dev: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test runtime image
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests:/tests \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.image_suffix }}-${{ needs.validate.outputs.version }} \
            /tests/test-image.sh

      - name: Test dev image
        if: matrix.dev
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/tests:/tests \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.image_suffix }}-${{ needs.validate.outputs.version }} \
            /tests/test-dev-image.sh

  # =============================================================================
  # MERGE: RELEASE (create git tag and GitHub release)
  # =============================================================================
  release:
    needs: [validate, test]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create git tag
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="v${VERSION}"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git tag -a "${TAG}" -m "Release ${VERSION}"
          git push origin "${TAG}"

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          NOTES=$(awk "/^## \\[${VERSION}\\]/{flag=1; next} /^## \\[/{flag=0} flag" CHANGELOG.md)

          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ needs.validate.outputs.version }}
          tag_name: v${{ needs.validate.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.notes }}

            ## Docker Images

            ```bash
            # Alpine (default)
            docker pull ghcr.io/${{ github.repository }}:latest
            docker pull ghcr.io/${{ github.repository }}:${{ needs.validate.outputs.version }}

            # Ubuntu
            docker pull ghcr.io/${{ github.repository }}:ubuntu-latest
            docker pull ghcr.io/${{ github.repository }}:ubuntu-${{ needs.validate.outputs.version }}

            # Development images (Alpine)
            docker pull ghcr.io/${{ github.repository }}:dev
            docker pull ghcr.io/${{ github.repository }}:dev-${{ needs.validate.outputs.version }}

            # Development images (Ubuntu)
            docker pull ghcr.io/${{ github.repository }}:ubuntu-dev-latest
            docker pull ghcr.io/${{ github.repository }}:ubuntu-dev-${{ needs.validate.outputs.version }}
            ```

            See [Container Registry](https://github.com/${{ github.repository }}/pkgs/container/spatialite-base-image) for all available tags.
          generate_release_notes: false
