# Alpine-based SpatiaLite development image with GDAL, GEOS, librttopo
# Use this image for building applications with CGO bindings
FROM alpine:3.21

LABEL maintainer="jobrunner"
LABEL description="Alpine-based dev image with GDAL, SQLite, SpatiaLite, GEOS, librttopo (includes headers)"

# Install runtime libraries + development packages + build tools
# hadolint ignore=DL3018
RUN apk add --no-cache \
    gdal \
    gdal-tools \
    sqlite \
    sqlite-libs \
    libspatialite \
    geos \
    librttopo \
    proj \
    ca-certificates \
    gdal-dev \
    sqlite-dev \
    libspatialite-dev \
    geos-dev \
    librttopo-dev \
    proj-dev \
    gcc \
    g++ \
    musl-dev \
    pkgconfig \
    # Create symlink for mod_spatialite (SQLite load_extension expects this name)
    && ln -s /usr/lib/mod_spatialite.so.* /usr/lib/mod_spatialite.so 2>/dev/null || true

# Install Go 1.24.4
ARG TARGETARCH
RUN case "${TARGETARCH}" in \
        amd64) GOARCH="amd64" ;; \
        arm64) GOARCH="arm64" ;; \
        *) echo "Unsupported architecture: ${TARGETARCH}" && exit 1 ;; \
    esac && \
    wget -q "https://go.dev/dl/go1.24.4.linux-${GOARCH}.tar.gz" -O /tmp/go.tar.gz && \
    tar -C /usr/local -xzf /tmp/go.tar.gz && \
    rm /tmp/go.tar.gz

# Security hardening: remove SUID/SGID bits from all binaries
RUN find / -xdev -perm /6000 -type f -exec chmod a-s {} \; 2>/dev/null || true

# Create non-root user for optional rootless operation
# Run with: docker run --user spatialite ...
RUN addgroup -g 10001 -S spatialite && \
    adduser -u 10001 -S -G spatialite -h /app spatialite

# Configure environment variables
ENV SPATIALITE_SECURITY=relaxed
ENV SQLITE_ENABLE_LOAD_EXTENSION=1
ENV LD_LIBRARY_PATH=/usr/lib:/usr/local/lib
ENV PATH=/usr/local/go/bin:$PATH
ENV GOPATH=/app/go

# Set working directory with proper permissions for both root and non-root
WORKDIR /app
RUN chown spatialite:spatialite /app

# Switch to non-root user (override with: docker run --user root ...)
USER spatialite

# Default command
CMD ["/bin/sh"]
