stages:
  - build
  - test
  - push

variables:
  DOCKER_BUILDKIT: "1"
  REGISTRY: registry.gitlab.com/fieldworksdiary/spatialite-image
  # Disable TLS for docker-in-docker
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2

# Reusable buildx setup
.buildx-setup: &buildx-setup
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - docker context create builder-context
  - docker buildx create --use --name multiarch-builder --driver docker-container builder-context
  - docker buildx inspect --bootstrap

# Common job configuration
.build-common:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    *buildx-setup
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

.push-common:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    *buildx-setup
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# BUILD STAGE
# =============================================================================

# Build Ubuntu runtime image
build:ubuntu:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu \
        --tag $REGISTRY:ubuntu-$CI_COMMIT_SHA \
        --push \
        .

# Build Ubuntu dev image
build:ubuntu-dev:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu-dev \
        --tag $REGISTRY:ubuntu-dev-$CI_COMMIT_SHA \
        --push \
        .

# Build Alpine runtime image
build:alpine:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine \
        --tag $REGISTRY:alpine-$CI_COMMIT_SHA \
        --push \
        .

# Build Alpine dev image
build:alpine-dev:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine-dev \
        --tag $REGISTRY:alpine-dev-$CI_COMMIT_SHA \
        --push \
        .

# =============================================================================
# TEST STAGE
# =============================================================================

# Test Ubuntu runtime image
test:ubuntu:
  stage: test
  image: $REGISTRY:ubuntu-$CI_COMMIT_SHA
  needs:
    - build:ubuntu
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# Test Ubuntu dev image
test:ubuntu-dev:
  stage: test
  image: $REGISTRY:ubuntu-dev-$CI_COMMIT_SHA
  needs:
    - build:ubuntu-dev
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
    - chmod +x tests/test-dev-image.sh
    - ./tests/test-dev-image.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# Test Alpine runtime image
test:alpine:
  stage: test
  image: $REGISTRY:alpine-$CI_COMMIT_SHA
  needs:
    - build:alpine
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# Test Alpine dev image
test:alpine-dev:
  stage: test
  image: $REGISTRY:alpine-dev-$CI_COMMIT_SHA
  needs:
    - build:alpine-dev
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
    - chmod +x tests/test-dev-image.sh
    - ./tests/test-dev-image.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# =============================================================================
# PUSH STAGE (latest tags for main branch)
# =============================================================================

# Push Ubuntu runtime image
push:ubuntu:
  extends: .push-common
  needs:
    - test:ubuntu
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu \
        --tag $REGISTRY:ubuntu-latest \
        --push \
        .

# Push Ubuntu dev image
push:ubuntu-dev:
  extends: .push-common
  needs:
    - test:ubuntu-dev
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu-dev \
        --tag $REGISTRY:ubuntu-dev-latest \
        --push \
        .

# Push Alpine runtime image
push:alpine:
  extends: .push-common
  needs:
    - test:alpine
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine \
        --tag $REGISTRY:alpine-latest \
        --tag $REGISTRY:latest \
        --push \
        .

# Push Alpine dev image
push:alpine-dev:
  extends: .push-common
  needs:
    - test:alpine-dev
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine-dev \
        --tag $REGISTRY:alpine-dev-latest \
        --tag $REGISTRY:dev \
        --push \
        .

# =============================================================================
# RELEASE TAGS (semantic versioning: v1.2.3 -> 1.2.3, 1.2, 1)
# =============================================================================

push:release:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    *buildx-setup
  script:
    # Extract version components from tag (expects vX.Y.Z format)
    - |
      VERSION=${CI_COMMIT_TAG#v}
      MAJOR=$(echo $VERSION | cut -d. -f1)
      MINOR=$(echo $VERSION | cut -d. -f2)
      PATCH=$(echo $VERSION | cut -d. -f3)
      echo "Version: $VERSION (major=$MAJOR, minor=$MINOR, patch=$PATCH)"
    # Ubuntu runtime: X.Y.Z, X.Y, X
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu \
        --tag $REGISTRY:ubuntu-$VERSION \
        --tag $REGISTRY:ubuntu-$MAJOR.$MINOR \
        --tag $REGISTRY:ubuntu-$MAJOR \
        --tag $REGISTRY:ubuntu-latest \
        --push \
        .
    # Ubuntu dev: X.Y.Z, X.Y, X
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu-dev \
        --tag $REGISTRY:ubuntu-dev-$VERSION \
        --tag $REGISTRY:ubuntu-dev-$MAJOR.$MINOR \
        --tag $REGISTRY:ubuntu-dev-$MAJOR \
        --tag $REGISTRY:ubuntu-dev-latest \
        --push \
        .
    # Alpine runtime: X.Y.Z, X.Y, X (also untagged versions)
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine \
        --tag $REGISTRY:alpine-$VERSION \
        --tag $REGISTRY:alpine-$MAJOR.$MINOR \
        --tag $REGISTRY:alpine-$MAJOR \
        --tag $REGISTRY:alpine-latest \
        --tag $REGISTRY:$VERSION \
        --tag $REGISTRY:$MAJOR.$MINOR \
        --tag $REGISTRY:$MAJOR \
        --tag $REGISTRY:latest \
        --push \
        .
    # Alpine dev: X.Y.Z, X.Y, X
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine-dev \
        --tag $REGISTRY:alpine-dev-$VERSION \
        --tag $REGISTRY:alpine-dev-$MAJOR.$MINOR \
        --tag $REGISTRY:alpine-dev-$MAJOR \
        --tag $REGISTRY:alpine-dev-latest \
        --tag $REGISTRY:dev-$VERSION \
        --tag $REGISTRY:dev-$MAJOR.$MINOR \
        --tag $REGISTRY:dev-$MAJOR \
        --tag $REGISTRY:dev \
        --push \
        .
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
