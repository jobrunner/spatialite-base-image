stages:
  - build
  - test
  - tag
  - release

variables:
  DOCKER_BUILDKIT: "1"
  REGISTRY: registry.gitlab.com/fieldworksdiary/spatialite-image
  # Disable TLS for docker-in-docker
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2

# Reusable buildx setup
.buildx-setup: &buildx-setup
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - docker context create builder-context
  - docker buildx create --use --name multiarch-builder --driver docker-container builder-context
  - docker buildx inspect --bootstrap

# =============================================================================
# BUILD STAGE (runs on MRs and master)
# =============================================================================

.build-common:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    *buildx-setup
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:ubuntu:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu \
        --tag $REGISTRY:ubuntu-$CI_COMMIT_SHA \
        --push \
        .

build:ubuntu-dev:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu-dev \
        --tag $REGISTRY:ubuntu-dev-$CI_COMMIT_SHA \
        --push \
        .

build:alpine:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine \
        --tag $REGISTRY:alpine-$CI_COMMIT_SHA \
        --push \
        .

build:alpine-dev:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine-dev \
        --tag $REGISTRY:alpine-dev-$CI_COMMIT_SHA \
        --push \
        .

# =============================================================================
# TEST STAGE (runs on MRs and master)
# =============================================================================

.test-common:
  stage: test
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:ubuntu:
  extends: .test-common
  image: $REGISTRY:ubuntu-$CI_COMMIT_SHA
  needs:
    - build:ubuntu
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh

test:ubuntu-dev:
  extends: .test-common
  image: $REGISTRY:ubuntu-dev-$CI_COMMIT_SHA
  needs:
    - build:ubuntu-dev
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
    - chmod +x tests/test-dev-image.sh
    - ./tests/test-dev-image.sh

test:alpine:
  extends: .test-common
  image: $REGISTRY:alpine-$CI_COMMIT_SHA
  needs:
    - build:alpine
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh

test:alpine-dev:
  extends: .test-common
  image: $REGISTRY:alpine-dev-$CI_COMMIT_SHA
  needs:
    - build:alpine-dev
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
    - chmod +x tests/test-dev-image.sh
    - ./tests/test-dev-image.sh

# =============================================================================
# TAG STAGE (only on master after successful tests)
# Creates git tag from VERSION file and triggers release
# =============================================================================

tag:release:
  stage: tag
  image: alpine:3.20
  needs:
    - test:ubuntu
    - test:ubuntu-dev
    - test:alpine
    - test:alpine-dev
  before_script:
    - apk add --no-cache git curl
  script:
    - |
      VERSION=$(cat VERSION | tr -d '[:space:]')
      TAG="v${VERSION}"
      echo "Checking if tag $TAG already exists..."

      # Check if tag already exists
      if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
        echo "Tag $TAG already exists, skipping tag creation"
        exit 0
      fi

      echo "Creating new tag $TAG"

      # Configure git
      git config user.email "ci@gitlab.com"
      git config user.name "GitLab CI"

      # Create and push tag using GitLab API (needs CI_JOB_TOKEN)
      curl --fail --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "{\"tag_name\": \"${TAG}\", \"ref\": \"${CI_COMMIT_SHA}\", \"message\": \"Release ${VERSION}\"}" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/repository/tags"
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# RELEASE STAGE (triggered by version tags)
# =============================================================================

.release-build:
  stage: release
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    *buildx-setup
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/

release:ubuntu:
  extends: .release-build
  script:
    - |
      VERSION=${CI_COMMIT_TAG#v}
      MAJOR=$(echo $VERSION | cut -d. -f1)
      MINOR=$(echo $VERSION | cut -d. -f2)
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu \
        --tag $REGISTRY:ubuntu-$VERSION \
        --tag $REGISTRY:ubuntu-$MAJOR.$MINOR \
        --tag $REGISTRY:ubuntu-$MAJOR \
        --tag $REGISTRY:ubuntu-latest \
        --push \
        .

release:ubuntu-dev:
  extends: .release-build
  script:
    - |
      VERSION=${CI_COMMIT_TAG#v}
      MAJOR=$(echo $VERSION | cut -d. -f1)
      MINOR=$(echo $VERSION | cut -d. -f2)
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu-dev \
        --tag $REGISTRY:ubuntu-dev-$VERSION \
        --tag $REGISTRY:ubuntu-dev-$MAJOR.$MINOR \
        --tag $REGISTRY:ubuntu-dev-$MAJOR \
        --tag $REGISTRY:ubuntu-dev-latest \
        --push \
        .

release:alpine:
  extends: .release-build
  script:
    - |
      VERSION=${CI_COMMIT_TAG#v}
      MAJOR=$(echo $VERSION | cut -d. -f1)
      MINOR=$(echo $VERSION | cut -d. -f2)
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine \
        --tag $REGISTRY:alpine-$VERSION \
        --tag $REGISTRY:alpine-$MAJOR.$MINOR \
        --tag $REGISTRY:alpine-$MAJOR \
        --tag $REGISTRY:alpine-latest \
        --tag $REGISTRY:$VERSION \
        --tag $REGISTRY:$MAJOR.$MINOR \
        --tag $REGISTRY:$MAJOR \
        --tag $REGISTRY:latest \
        --push \
        .

release:alpine-dev:
  extends: .release-build
  script:
    - |
      VERSION=${CI_COMMIT_TAG#v}
      MAJOR=$(echo $VERSION | cut -d. -f1)
      MINOR=$(echo $VERSION | cut -d. -f2)
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine-dev \
        --tag $REGISTRY:alpine-dev-$VERSION \
        --tag $REGISTRY:alpine-dev-$MAJOR.$MINOR \
        --tag $REGISTRY:alpine-dev-$MAJOR \
        --tag $REGISTRY:alpine-dev-latest \
        --tag $REGISTRY:dev-$VERSION \
        --tag $REGISTRY:dev-$MAJOR.$MINOR \
        --tag $REGISTRY:dev-$MAJOR \
        --tag $REGISTRY:dev \
        --push \
        .

# Create GitLab Release with changelog
release:create:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - release:ubuntu
    - release:ubuntu-dev
    - release:alpine
    - release:alpine-dev
  script:
    - echo "Creating GitLab release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: "./CHANGELOG.md"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
