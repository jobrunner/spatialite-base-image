stages:
  - build
  - test
  - push

variables:
  DOCKER_BUILDKIT: "1"
  REGISTRY: registry.gitlab.com/fieldworksdiary/spatialite-image
  # Disable TLS for docker-in-docker
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2

# Reusable buildx setup
.buildx-setup: &buildx-setup
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - docker context create builder-context
  - docker buildx create --use --name multiarch-builder --driver docker-container builder-context
  - docker buildx inspect --bootstrap

# Common job configuration
.build-common:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    *buildx-setup
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

.push-common:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    *buildx-setup
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# BUILD STAGE
# =============================================================================

# Build Ubuntu runtime image
build:ubuntu:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu \
        --tag $REGISTRY:ubuntu-$CI_COMMIT_SHA \
        --push \
        .

# Build Ubuntu dev image
build:ubuntu-dev:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu-dev \
        --tag $REGISTRY:ubuntu-dev-$CI_COMMIT_SHA \
        --push \
        .

# Build Alpine runtime image
build:alpine:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine \
        --tag $REGISTRY:alpine-$CI_COMMIT_SHA \
        --push \
        .

# Build Alpine dev image
build:alpine-dev:
  extends: .build-common
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine-dev \
        --tag $REGISTRY:alpine-dev-$CI_COMMIT_SHA \
        --push \
        .

# =============================================================================
# TEST STAGE
# =============================================================================

# Test Ubuntu runtime image
test:ubuntu:
  stage: test
  image: $REGISTRY:ubuntu-$CI_COMMIT_SHA
  needs:
    - build:ubuntu
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# Test Ubuntu dev image
test:ubuntu-dev:
  stage: test
  image: $REGISTRY:ubuntu-dev-$CI_COMMIT_SHA
  needs:
    - build:ubuntu-dev
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
    - chmod +x tests/test-dev-image.sh
    - ./tests/test-dev-image.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# Test Alpine runtime image
test:alpine:
  stage: test
  image: $REGISTRY:alpine-$CI_COMMIT_SHA
  needs:
    - build:alpine
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# Test Alpine dev image
test:alpine-dev:
  stage: test
  image: $REGISTRY:alpine-dev-$CI_COMMIT_SHA
  needs:
    - build:alpine-dev
  script:
    - chmod +x tests/test-image.sh
    - ./tests/test-image.sh
    - chmod +x tests/test-dev-image.sh
    - ./tests/test-dev-image.sh
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_MERGE_REQUEST_ID

# =============================================================================
# PUSH STAGE
# =============================================================================

# Push Ubuntu runtime image
push:ubuntu:
  extends: .push-common
  needs:
    - test:ubuntu
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu \
        --tag $REGISTRY:ubuntu-latest \
        --tag $REGISTRY:ubuntu-$CI_COMMIT_REF_SLUG \
        --push \
        .

# Push Ubuntu dev image
push:ubuntu-dev:
  extends: .push-common
  needs:
    - test:ubuntu-dev
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu-dev \
        --tag $REGISTRY:ubuntu-dev-latest \
        --tag $REGISTRY:ubuntu-dev-$CI_COMMIT_REF_SLUG \
        --push \
        .

# Push Alpine runtime image
push:alpine:
  extends: .push-common
  needs:
    - test:alpine
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine \
        --tag $REGISTRY:alpine-latest \
        --tag $REGISTRY:alpine-$CI_COMMIT_REF_SLUG \
        --tag $REGISTRY:latest \
        --push \
        .

# Push Alpine dev image
push:alpine-dev:
  extends: .push-common
  needs:
    - test:alpine-dev
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine-dev \
        --tag $REGISTRY:alpine-dev-latest \
        --tag $REGISTRY:alpine-dev-$CI_COMMIT_REF_SLUG \
        --tag $REGISTRY:dev \
        --push \
        .

# =============================================================================
# RELEASE TAGS
# =============================================================================

push:release:
  stage: push
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    *buildx-setup
  script:
    # Ubuntu runtime
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu \
        --tag $REGISTRY:ubuntu-$CI_COMMIT_TAG \
        --push \
        .
    # Ubuntu dev
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.ubuntu-dev \
        --tag $REGISTRY:ubuntu-dev-$CI_COMMIT_TAG \
        --push \
        .
    # Alpine runtime
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine \
        --tag $REGISTRY:alpine-$CI_COMMIT_TAG \
        --tag $REGISTRY:$CI_COMMIT_TAG \
        --push \
        .
    # Alpine dev
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --file Dockerfile.alpine-dev \
        --tag $REGISTRY:alpine-dev-$CI_COMMIT_TAG \
        --tag $REGISTRY:dev-$CI_COMMIT_TAG \
        --push \
        .
  rules:
    - if: $CI_COMMIT_TAG
